//Library has been modified for STM32F0xx by Aleksey Sedyshev
//https://github.com/AlekseySedyshev

#include "stm32f0xx.h"  
#include "LCD_1202.h"  
#include "main.h" 

char LCD_CurrentX = 0;
char LCD_CurrentY = 0;
const char LCD_ZERO = 0;
const char LCD_FILL = 0xFF;
char lcd_print_buffer[LCD_PRINT_INT_MAX_WIDTH + 2];


const char lcd_reset_sequence[] = {0xE2}; // Internal reset

const char lcd_init_sequence[] = 						{
	0xEB, // Thermal comp. on
	0x2F, // Supply mode
	0xA9, // Horisontal reverse: Reverse - 0xA9, Normal - 0xA1
//	0xC9, // Vertical reverse (comment if no need)
	0xA6, // Positive - A7, Negative - A6
	0x85, // Contrast 0x90...0x9F
	0xEC, // Set refresh rate to 80 Hz
	0xAF, // Enable LCD
	0xA4 // Clear screen
};

const char lcd_chars[][6] = 								{
                {0x00, 0x00, 0x00, 0x00, 0x00}, // 0x20' '
                {0x00, 0x00, 0x5E, 0x00, 0x00}, // 0x21'!'
                {0x00, 0x06, 0x00, 0x06, 0x00}, // 0x22'"'
                {0x24, 0x7E, 0x24, 0x7E, 0x24}, // 0x23'#'
                {0x08, 0x54, 0xD6, 0x54, 0x20}, // 0x24'$'
                {0x44, 0x20, 0x10, 0x08, 0x44}, // 0x25'%'
                {0x34, 0x4A, 0x54, 0x20, 0x50}, // 0x26'&'
                {0x00, 0x00, 0x06, 0x00, 0x00}, // 0x27'''
                {0x00, 0x3C, 0x42, 0x00, 0x00}, // 0x28'('
                {0x00, 0x00, 0x42, 0x3C, 0x00}, // 0x29')'
                {0x00, 0x14, 0x08, 0x14, 0x00}, // 0x2A'*'
                {0x10, 0x10, 0x7C, 0x10, 0x10}, // 0x2B'+'
                {0x00, 0x80, 0x40, 0x00, 0x00}, // 0x2C','
                {0x10, 0x10, 0x10, 0x10, 0x00}, // 0x2D'-'
                {0x00, 0x00, 0x40, 0x00, 0x00}, // 0x2E'.'
                {0x00, 0x60, 0x18, 0x06, 0x00}, // 0x2F'/'
                {0x3C, 0x62, 0x5A, 0x46, 0x3C}, // 0x30'0'
                {0x00, 0x08, 0x04, 0x7E, 0x00}, // 0x31'1'
                {0x64, 0x52, 0x52, 0x52, 0x4C}, // 0x32'2'
                {0x24, 0x42, 0x4A, 0x4A, 0x34}, // 0x33'3'
                {0x1E, 0x10, 0x10, 0x10, 0x7E}, // 0x34'4'
                {0x26, 0x4A, 0x4A, 0x4A, 0x32}, // 0x35'5'
                {0x3C, 0x4A, 0x4A, 0x4A, 0x30}, // 0x36'6'
                {0x02, 0x02, 0x72, 0x0A, 0x06}, // 0x37'7'
                {0x34, 0x4A, 0x4A, 0x4A, 0x34}, // 0x38'8'
                {0x0C, 0x52, 0x52, 0x52, 0x3C}, // 0x39'9'
                {0x00, 0x00, 0x44, 0x00, 0x00}, // 0x3A':'
                {0x00, 0x80, 0x44, 0x00, 0x00}, // 0x3B';'
                {0x00, 0x10, 0x28, 0x44, 0x00}, // 0x3C'<'
                {0x00, 0x28, 0x28, 0x28, 0x00}, // 0x3D'='
                {0x00, 0x44, 0x28, 0x10, 0x00}, // 0x3E'>'
                {0x00, 0x02, 0x5A, 0x04, 0x00}, // 0x3F'?'
                {0x3C, 0x42, 0x5A, 0x52, 0x0C}, // 0x40'@'
                {0x7C, 0x12, 0x12, 0x12, 0x7C}, // 0x41'A'
                {0x7E, 0x4A, 0x4A, 0x4A, 0x34}, // 0x42'B'
                {0x3C, 0x42, 0x42, 0x42, 0x24}, // 0x43'C'
                {0x7E, 0x42, 0x42, 0x42, 0x3C}, // 0x44'D'
                {0x7E, 0x4A, 0x4A, 0x42, 0x42}, // 0x45'E'
                {0x7E, 0x0A, 0x0A, 0x0A, 0x02}, // 0x46'F'
                {0x3C, 0x42, 0x52, 0x52, 0x34}, // 0x47'G'
                {0x7E, 0x08, 0x08, 0x08, 0x7E}, // 0x48'H'
                {0x42, 0x42, 0x7E, 0x42, 0x42}, // 0x49'I'
                {0x42, 0x42, 0x3E, 0x02, 0x02}, // 0x4A'J'
                {0x7E, 0x08, 0x08, 0x14, 0x62}, // 0x4B'K'
                {0x7E, 0x40, 0x40, 0x40, 0x40}, // 0x4C'L'
                {0x7E, 0x04, 0x18, 0x04, 0x7E}, // 0x4D'M'
                {0x7E, 0x04, 0x08, 0x10, 0x7E}, // 0x4E'N'
                {0x3C, 0x42, 0x42, 0x42, 0x3C}, // 0x4F'O'
                {0x7E, 0x12, 0x12, 0x12, 0x0C}, // 0x50'P'
                {0x3C, 0x42, 0x42, 0x42, 0xBC}, // 0x51'Q'
                {0x7E, 0x12, 0x12, 0x12, 0x6C}, // 0x52'R'
                {0x24, 0x4A, 0x4A, 0x52, 0x24}, // 0x53'S'
                {0x02, 0x02, 0x7E, 0x02, 0x02}, // 0x54'T'
                {0x3E, 0x40, 0x40, 0x40, 0x3E}, // 0x55'U'
                {0x06, 0x18, 0x60, 0x18, 0x06}, // 0x56'V'
                {0x3E, 0x40, 0x30, 0x40, 0x3E}, // 0x57'W'
                {0x42, 0x24, 0x18, 0x24, 0x42}, // 0x58'X'
                {0x06, 0x08, 0x70, 0x08, 0x06}, // 0x59'Y'
                {0x62, 0x52, 0x4A, 0x46, 0x42}, // 0x5A'Z'
                {0x00, 0x7E, 0x42, 0x00, 0x00}, // 0x5B'['
                {0x00, 0x06, 0x18, 0x60, 0x00}, // 0x5C'\'
                {0x00, 0x00, 0x42, 0x7E, 0x00}, // 0x5D']'
                {0x00, 0x04, 0x02, 0x04, 0x00}, // 0x5E'^'
                {0x40, 0x40, 0x40, 0x40, 0x40}, // 0x5F'_'
                {0x00, 0x02, 0x04, 0x00, 0x00}, // 0x60'`'
                {0x20, 0x54, 0x54, 0x78, 0x00}, // 0x61'a'
                {0x7E, 0x48, 0x48, 0x30, 0x00}, // 0x62'b'
                {0x38, 0x44, 0x44, 0x28, 0x00}, // 0x63'c'
                {0x30, 0x48, 0x48, 0x7E, 0x00}, // 0x64'd'
                {0x38, 0x54, 0x54, 0x18, 0x00}, // 0x65'e'
                {0x10, 0x7C, 0x12, 0x02, 0x00}, // 0x66'f'
                {0x18, 0xA4, 0xA4, 0x78, 0x00}, // 0x67'g'
                {0x7E, 0x08, 0x08, 0x70, 0x00}, // 0x68'h'
                {0x00, 0x00, 0x7A, 0x00, 0x00}, // 0x69'i'
                {0x80, 0x80, 0x7A, 0x00, 0x00}, // 0x6A'j'
                {0x7E, 0x10, 0x28, 0x40, 0x00}, // 0x6B'k'
                {0x00, 0x00, 0x3E, 0x40, 0x00}, // 0x6C'l'
                {0x7C, 0x04, 0x18, 0x04, 0x78}, // 0x6D'm'
                {0x7C, 0x08, 0x04, 0x78, 0x00}, // 0x6E'n'
                {0x38, 0x44, 0x44, 0x38, 0x00}, // 0x6F'o'
                {0xFC, 0x24, 0x24, 0x18, 0x00}, // 0x70'p'
                {0x18, 0x24, 0x24, 0xFC, 0x00}, // 0x71'q'
                {0x7C, 0x08, 0x04, 0x04, 0x00}, // 0x72'r'
                {0x48, 0x54, 0x54, 0x24, 0x00}, // 0x73's'
                {0x08, 0x3E, 0x48, 0x40, 0x00}, // 0x74't'
                {0x3C, 0x40, 0x40, 0x3C, 0x00}, // 0x75'u'
                {0x1C, 0x20, 0x40, 0x20, 0x1C}, // 0x76'v'
                {0x3C, 0x40, 0x30, 0x40, 0x3C}, // 0x77'w'
                {0x44, 0x28, 0x10, 0x28, 0x44}, // 0x78'x'
                {0x1C, 0xA0, 0xA0, 0x7C, 0x00}, // 0x79'y'
                {0x44, 0x64, 0x54, 0x4C, 0x00}, // 0x7A'z'
                {0x10, 0x6C, 0x82, 0x00, 0x00}, // 0x7B'{'
                {0x00, 0x00, 0xFE, 0x00, 0x00}, // 0x7C'|'
                {0x00, 0x00, 0x82, 0x6C, 0x10}, // 0x7D'}'
                {0x08, 0x04, 0x0C, 0x08, 0x04}, // 0x7E'~'
                {0x78, 0x14, 0x12, 0x14, 0x78}, // 0xC0'А'
                {0x7E, 0x4A, 0x4A, 0x4A, 0x30}, // 0xC1'Б'
                {0x7E, 0x4A, 0x4A, 0x4C, 0x30}, // 0xC2'В'
                {0x7E, 0x02, 0x02, 0x02, 0x02}, // 0xC3'Г'
                {0x60, 0x3C, 0x22, 0x3E, 0x60}, // 0xC4'Д'
                {0x7E, 0x4A, 0x4A, 0x42, 0x42}, // 0xC5'Е'
                {0x66, 0x18, 0x7E, 0x18, 0x66}, // 0xC6'Ж'
                {0x42, 0x42, 0x4A, 0x4A, 0x34}, // 0xC7'З'
                {0x7E, 0x10, 0x08, 0x04, 0x7E}, // 0xC8'И'
                {0x7E, 0x10, 0x09, 0x04, 0x7E}, // 0xC9'Й'
                {0x7E, 0x10, 0x08, 0x14, 0x62}, // 0xCA'К'
                {0x40, 0x3C, 0x02, 0x02, 0x7E}, // 0xCB'Л'
                {0x7E, 0x04, 0x08, 0x04, 0x7E}, // 0xCC'М'
                {0x7E, 0x08, 0x08, 0x08, 0x7E}, // 0xCD'Н'
                {0x3C, 0x42, 0x42, 0x42, 0x3C}, // 0xCE'О'
                {0x7E, 0x02, 0x02, 0x02, 0x7E}, // 0xCF'П'
                {0x7E, 0x12, 0x12, 0x12, 0x0C}, // 0xD0'Р'
                {0x3C, 0x42, 0x42, 0x42, 0x24}, // 0xD1'С'
                {0x02, 0x02, 0x7E, 0x02, 0x02}, // 0xD2'Т'
                {0x46, 0x28, 0x10, 0x08, 0x06}, // 0xD3'У'
                {0x1C, 0x22, 0x7E, 0x22, 0x1C}, // 0xD4'Ф'
                {0x42, 0x24, 0x18, 0x24, 0x42}, // 0xD5'Х'
                {0x7E, 0x40, 0x40, 0x7E, 0xC0}, // 0xD6'Ц'
                {0x0E, 0x10, 0x10, 0x10, 0x7E}, // 0xD7'Ч'
                {0x7E, 0x40, 0x7C, 0x40, 0x7E}, // 0xD8'Ш'
                {0x7E, 0x40, 0x7C, 0x40, 0xFE}, // 0xD9'Щ'
                {0x02, 0x7E, 0x48, 0x48, 0x30}, // 0xDA'Ъ'
                {0x7E, 0x48, 0x30, 0x00, 0x7E}, // 0xDB'Ы'
                {0x7E, 0x48, 0x48, 0x48, 0x30}, // 0xDC'Ь'
                {0x42, 0x4A, 0x4A, 0x4A, 0x3C}, // 0xDD'Э'
                {0x7E, 0x08, 0x3C, 0x42, 0x3C}, // 0xDE'Ю'
                {0x4C, 0x52, 0x32, 0x12, 0x7E}, // 0xDF'Я'
                {0x20, 0x54, 0x54, 0x78, 0x00}, // 0xE0'а'
                {0x7C, 0x54, 0x54, 0x20, 0x00}, // 0xE1'б'
                {0x7C, 0x54, 0x54, 0x28, 0x00}, // 0xE2'в'
                {0x7C, 0x04, 0x04, 0x04, 0x00}, // 0xE3'г'
                {0xC0, 0x78, 0x44, 0x7C, 0xC0}, // 0xE4'д'
                {0x38, 0x54, 0x54, 0x18, 0x00}, // 0xE5'е'
                {0x64, 0x18, 0x7C, 0x18, 0x64}, // 0xE6'ж'
                {0x00, 0x44, 0x54, 0x54, 0x28}, // 0xE7'з'
                {0x7C, 0x20, 0x10, 0x7C, 0x00}, // 0xE8'и'
                {0x78, 0x22, 0x12, 0x78, 0x00}, // 0xE9'й'
                {0x7C, 0x10, 0x28, 0x44, 0x00}, // 0xEA'к'
                {0x40, 0x3C, 0x04, 0x7C, 0x00}, // 0xEB'л'
                {0x7C, 0x08, 0x10, 0x08, 0x7C}, // 0xEC'м'
                {0x7C, 0x10, 0x10, 0x7C, 0x00}, // 0xED'н'
                {0x38, 0x44, 0x44, 0x38, 0x00}, // 0xEE'о'
                {0x7C, 0x04, 0x04, 0x7C, 0x00}, // 0xEF'п'
                {0xFC, 0x24, 0x24, 0x18, 0x00}, // 0xF0'р'
                {0x38, 0x44, 0x44, 0x28, 0x00}, // 0xF1'с'
                {0x00, 0x04, 0x7C, 0x04, 0x00}, // 0xF2'т'
                {0x44, 0x28, 0x10, 0x08, 0x04}, // 0xF3'у'
                {0x30, 0x48, 0xFC, 0x48, 0x30}, // 0xF4'ф'
                {0x44, 0x28, 0x10, 0x28, 0x44}, // 0xF5'х'
                {0x7C, 0x40, 0x40, 0x7C, 0x80}, // 0xF6'ц'
                {0x0C, 0x10, 0x10, 0x7C, 0x00}, // 0xF7'ч'
                {0x7C, 0x40, 0x78, 0x40, 0x7C}, // 0xF8'ш'
                {0x7C, 0x40, 0x78, 0x40, 0xFC}, // 0xF9'щ'
                {0x04, 0x7C, 0x50, 0x50, 0x20}, // 0xFA'ъ'
                {0x7C, 0x50, 0x50, 0x20, 0x7C}, // 0xFB'ы'
                {0x7C, 0x50, 0x50, 0x20, 0x00}, // 0xFC'ь'
                {0x00, 0x44, 0x44, 0x54, 0x38}, // 0xFD'э'
                {0x7C, 0x10, 0x38, 0x44, 0x38}, // 0xFE'ю'
                {0x48, 0x34, 0x14, 0x7C, 0x00}, // 0xFF'я'
    };
 


void lcd_write(char cd, const char * data, unsigned short int len, unsigned short int repeat)		{
    char i;
		
    while(repeat > 0)
    {			
        for(i = 0; i < len; i++)
        {            
					CS_LO();
					unsigned short int octet = data[i];
					if (cd) octet |= 0x100;
					while (!(SPI1->SR & SPI_SR_TXE)){};	 
					SPI1->DR = octet;
					while (SPI1->SR & SPI_SR_BSY){};
				CS_HI();
		    }    
        repeat --;
    }
	while (SPI1->SR & SPI_SR_BSY){};
	
}


void lcd_print_int(int value)								{
    char pos = LCD_PRINT_INT_MAX_WIDTH;   
    char sign = 0;
    if (value < 0)
    {
        sign = 1;
        value = -value;                                                                            
    }

    lcd_print_buffer[LCD_PRINT_INT_MAX_WIDTH + 1] = 0;
    
    do {
        lcd_print_buffer[pos--] = value % 10 + '0';
        value /= 10;
    } while (value != 0);

    if (sign)
        lcd_print_buffer[pos--] = '-';

    lcd_print_string(lcd_print_buffer + pos + 1);
}

void lcd_print_Hex(int value)								{
    char pos = LCD_PRINT_INT_MAX_WIDTH;   
    char sign = 0;
    if (value < 0)
    {
        sign = 1;
        value = -value;                                                                            
    }

    lcd_print_buffer[LCD_PRINT_INT_MAX_WIDTH + 1] = 0;
    
    do {
        if(value%0x10 <10) 	{lcd_print_buffer[pos--] = value % 0x10 + '0';}
					else 							{lcd_print_buffer[pos--] = value % 0x10 + 0x37;}
        value /= 0x10;
    } while (value != 0);

    if (sign)
        lcd_print_buffer[pos--] = '-';

    lcd_print_string(lcd_print_buffer + pos + 1);
}

void lcd_print_string(const char *s)				{
    for(;*s != 0; s++)    
        lcd_print_char(*s);
}    
    
void lcd_print_char(char c)									{
    const char *cb;
    char l = 0, r = 4;
    
    if (c > '~') c -= 65;
    c -= 32;      
    
    cb = lcd_chars[c];

    if (c != 0)
    {                                                   
        while (cb[l] == 0) l++;
        while (cb[r] == 0) r--;
    } else
        r = 0;
    lcd_write(LCD_DATA, cb + l, r - l + 2, 1);  
}

void lcd_clear(void)												{
    lcd_write(1, &LCD_ZERO, 1, 864);
}
void lcd_init(void)													{
	RES_ON(); //Reset LCD
	delay_ms(100);
	RES_OFF();	

	lcd_write(LCD_COMMAND, lcd_reset_sequence,sizeof(lcd_reset_sequence), 1); //Send internal reset
	delay_ms(100);
	lcd_write(LCD_COMMAND, lcd_init_sequence, sizeof(lcd_init_sequence), 1); //Send initialization sequence
  lcd_clear();    
}




void lcd_gotoxy(char x, char y)							{
    char sequence[3];
    sequence[0] = 0xB0 | (y & 0x0F);        //Y addressing: 1011yyyy
    sequence[1] = x & 0x0F;                 //X addressing: 0000xxxx, lower bits
    sequence[2] = 0x10 | ((x >> 4) & 0x07); //X addressing: 00010xxx, higher bits
    lcd_write(LCD_COMMAND, sequence, 3, 1);
    LCD_CurrentX = x;
    LCD_CurrentY = y;
}
